version: '3.8'
services:
  nginx:
      image: nginx:latest
      container_name: reverse-proxy
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./nginx-conf:/etc/nginx/conf.d
        - /etc/letsencrypt:/etc/letsencrypt
      networks:
        - blockchain_network
  btc-node:
    image: bitcoin/bitcoin:latest
    container_name: btc-node
    restart: always
    command: >
      sh -c "bitcoind -conf=/bitcoin.conf -datadir=/data
      -rpcuser=${BTC_RPC_USER}
      -rpcpassword=${BTC_RPC_PASSWORD}"
    ports:
      - "${BTC_RPC_PORT}:8332" # BTC RPC
      - "8333:8333" # BTC P2P
    volumes:
      - ./btc/data:/data
      - ./btc/bitcoin.conf:/bitcoin.conf
    env_file: .env
    healthcheck:
      test: ["CMD", "/opt/bitcoin-27.1/bin/bitcoin-cli", "-conf=/bitcoin.conf", "-rpcuser=${BTC_RPC_USER}", "-rpcpassword=${BTC_RPC_PASSWORD}", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - blockchain_network

  fractal-node:
    image: fractalbitcoin/fractal:v0.2.1
    env_file: .env
    container_name: fractal-node
    restart: always
    command: >
      sh -c "bitcoind -conf=/bitcoin.conf -datadir=/data -maxtipage=504576000
      -rpcuser=${FRACTAL_RPC_USER}
      -rpcpassword=${FRACTAL_RPC_PASSWORD}"
    ports:
      - "${FRACTAL_RPC_PORT}:8332"
      - "18333:8333"
    volumes:
      - ./fractal/data:/data
      - ./fractal/bitcoin.conf:/bitcoin.conf
    networks:
      - blockchain_network
    healthcheck:
      test: ["CMD", "/usr/local/bin/bitcoin-cli", "-conf=/bitcoin.conf", "-rpcuser=${FRACTAL_RPC_USER}", "-rpcpassword=${FRACTAL_RPC_PASSWORD}", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  bells-node:
    build:
      context: ./bells
      dockerfile: Dockerfile
    env_file: .env
    container_name: bells-node
    restart: always
    command: >
      sh -c "./bellsd -conf=/bells/bitcoin.conf -datadir=/data
      -rpcuser=${BELLS_RPC_USER}
      -rpcpassword=${BELLS_RPC_PASSWORD}"
    ports:
      - "${BELLS_RPC_PORT}:8332"
      - "28333:8333"
    volumes:
      - ./bells/data:/data
      - ./bells/bitcoin.conf:/bells/bitcoin.conf
    networks:
      - blockchain_network
    healthcheck:
      test: ["CMD", "/opt/bells-3.0.0-rc2/bin/bells-cli", "-conf=/bells/bitcoin.conf", "-rpcuser=${BELLS_RPC_USER}", "-rpcpassword=${BELLS_RPC_PASSWORD}", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file: ./dashboard/.env
    networks:
      - blockchain_network
networks:
  blockchain_network:
    driver: bridge