version: '3.8'

env_file: .env

services:
  btc-node:
    image: bitcoin/bitcoin:latest
    container_name: btc-node
    restart: always
    command: >
      sh -c "bitcoind -conf=/bitcoin.conf -datadir=/data
      -rpcuser=$${BTC_RPC_USER}
      -rpcpassword=$${BTC_RPC_PASSWORD}"
    environment:
      - BTC_RPC_USER=${BTC_RPC_USER}
      - BTC_RPC_PASSWORD=${BTC_RPC_PASSWORD}
    ports:
      - "8332:8332"  # BTC RPC
      - "8333:8333"  # BTC P2P
    volumes:
      - ./btc/data:/data
      - ./btc/bitcoin.conf:/bitcoin.conf
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-conf=/bitcoin.conf", "-datadir=/data", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "1g"
        max-file: "3"

  fractal-node:
    image: fractalbitcoin/fractal:v0.2.1
    container_name: fractal-node
    restart: always
    command: >
      sh -c "bitcoind -conf=/bitcoin.conf -datadir=/data -maxtipage=504576000
      -rpcuser=$${FRACTAL_RPC_USER}
      -rpcpassword=$${FRACTAL_RPC_PASSWORD}"
    environment:
      - FRACTAL_RPC_USER=${FRACTAL_RPC_USER}
      - FRACTAL_RPC_PASSWORD=${FRACTAL_RPC_PASSWORD}
    ports:
      - "18332:8332"
      - "18333:8333"
    volumes:
      - ./fractal/data:/data
      - ./fractal/bitcoin.conf:/bitcoin.conf
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-conf=/bitcoin.conf", "-datadir=/data", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
    mem_limit: 40G
    memswap_limit: 60G
    mem_swappiness: 100
    logging:
      driver: "json-file"
      options:
        max-size: "1g"
        max-file: "3"

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        BUILDTIME_ENV_VARS: "${BTC_RPC_USER},${BTC_RPC_PASSWORD},${BTC_RPC_HOST},${BTC_RPC_PORT},${FRACTAL_RPC_USER},${FRACTAL_RPC_PASSWORD},${FRACTAL_RPC_HOST},${FRACTAL_RPC_PORT},${MASTER_PASSWORD},${JWT_SECRET}"
    ports:
      - "3000:3000"
    environment:
      - DASHBOARD_ENV_VARS=${BTC_RPC_USER},${BTC_RPC_PASSWORD},${BTC_RPC_HOST},${BTC_RPC_PORT},${FRACTAL_RPC_USER},${FRACTAL_RPC_PASSWORD},${FRACTAL_RPC_HOST},${FRACTAL_RPC_PORT},${MASTER_PASSWORD},${JWT_SECRET}