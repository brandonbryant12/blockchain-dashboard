version: '3.8'

services:
  btc-node:
    image: bitcoin/bitcoin:latest
    container_name: btc-node
    restart: always
    command: >
      sh -c "bitcoind -conf=/bitcoin.conf -datadir=/data
      -rpcuser=$${BTC_RPC_USER}
      -rpcpassword=$${BTC_RPC_PASSWORD}"
    ports:
      - "${BTC_RPC_PORT}:8332"  # BTC RPC
      - "8333:8333"  # BTC P2P
    volumes:
      - ./btc/data:/data
      - ./btc/bitcoin.conf:/bitcoin.conf
    env_file: .env
    healthcheck:
      test: ["CMD", "/opt/bitcoin-27.1/bin/bitcoin-cli -conf=/bitcoin.conf -datadir=/data -rpcuser=${BTC_RPC_USER} -rpcpassword=${BTC_RPC_PASSWORD} getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - blockchain_network

  fractal-node:
    image: fractalbitcoin/fractal:v0.2.1
    env_file: .env
    container_name: fractal-node
    restart: always
    command: >
      sh -c "bitcoind -conf=/bitcoin.conf -datadir=/data -maxtipage=504576000
      -rpcuser=$${FRACTAL_RPC_USER}
      -rpcpassword=$${FRACTAL_RPC_PASSWORD}"
    ports:
      - "${FRACTAL_RPC_PORT}:8332"
      - "18333:8333"
    volumes:
      - ./fractal/data:/data
      - ./fractal/bitcoin.conf:/bitcoin.conf
    healthcheck:
      test: ["CMD", "/usr/local/bin/bitcoin-cli -conf=/bitcoin.conf -datadir=/data -rpcuser=${FRACTAL_RPC_USER} -rpcpassword=${FRACTAL_RPC_PASSWORD} getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - blockchain_network
  bells-node:
    build:
      context: ./bells
      dockerfile: Dockerfile
    env_file: .env
    container_name: bells-node
    restart: always
    command: >
      sh -c "./bellsd -conf=/bells/bitcoin.conf -datadir=/data
      -rpcuser=$${BELLS_RPC_USER}
      -rpcpassword=$${BELLS_RPC_PASSWORD}"
    ports:
      - "${BELLS_RPC_PORT}:8332"
      - "28333:8333"
    volumes:
      - ./bells/data:/data
      - ./bells/bitcoin.conf:/bells/bitcoin.conf
    healthcheck:
      test: ["CMD", "./bells-cli -conf=/bells/bitcoin.conf -datadir=/data -rpcuser=${BELLS_RPC_USER} -rpcpassword=${BELLS_RPC_PASSWORD} getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - blockchain_network
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file: .env
    networks:
      - blockchain_network
    depends_on:
    - btc-node
    - fractal-node
networks:
  blockchain_network:
    driver: bridge